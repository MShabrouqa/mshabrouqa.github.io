<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESP Web Server</title>
<style>
    body { text-align: center; }
    .led-container {
        max-width: auto;
        margin: auto auto;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 25px;
        justify-content: center; }
    .led-button {
        color: white;
        font-weight: bold;
        padding: 17px;
        box-sizing: border-box;
        display: none; 
        max-width: auto; }
    #value { display: none; }
</style>


<script>
var server = "sgp1";
var token = localStorage.getItem("token") || ""; 

function checkLink() {
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
        if (this.readyState == 4) {
            if (this.status == 200) {
                if (this.responseText === "true") {
                    document.getElementById("result").innerText = "Device is connected."; } 
                else { document.getElementById("result").innerText = "Device is not connected."; }} 
            else { document.getElementById("result").innerText = "Please set token"; }}}; 
    xhttp.open("GET", "https://"+server+".blynk.cloud/external/api/isHardwareConnected?token=" + token, true);
    xhttp.send();}

function displayValue() {
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            if (this.responseText !== "0" && this.responseText !== "1") {
                document.getElementById("value").innerText = "Value: " + this.responseText;
                for (var i = 0; i < this.responseText.length; i++) {
                    var digit = this.responseText.charAt(i);
                    var buttonId = "led" + (i + 1);
                    var button = document.getElementById(buttonId);
    var lastGridStyle = localStorage.getItem('gridStyle');
    if (lastGridStyle === 'grid1') {button.style.backgroundColor = "grey";}  
                    else  {
                    if (digit === "0") {
                        button.style.backgroundColor = "green";} 
                        else if (digit === "1") {
                        button.style.backgroundColor = "red";  } 
                        else {button.style.backgroundColor = ""; }}}}}};
    xhttp.open("GET", "https://"+server+".blynk.cloud/external/api/get?token=" + token + "&v3", true);
    xhttp.send();}

function updateValue(value, buttonId) {
    var url = "https://"+server+".blynk.cloud/external/api/update?token=" + token + "&v1=" + value;
    hitWebsite(url, buttonId);}

function hitWebsite(url, buttonId) {
    var button = document.getElementById(buttonId);
    button.innerText = "Loading...";
    button.disabled = true;
    var xhr = new XMLHttpRequest();
    xhr.open("GET", url, true);
    xhr.onreadystatechange = function () {
        if (xhr.readyState === 4) {
            button.disabled = false;}}; 
    xhr.send();
	checkLink();
    checkArraySize();
	fetchDataAndExtractVariables();  }

function checkArraySize() {
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            var arraySize = parseInt(this.responseText);
                for (var i = 1; i <= arraySize; i++) { if( document.getElementById("led" + i).innerText !="" ){
                    document.getElementById("led" + i).style.display = "inline-block";}}}}; 
    xhttp.open("GET", "https://"+server+".blynk.cloud/external/api/get?token=" + token + "&v2", true);
    xhttp.send();}

function setToken() {
    var newToken = prompt("Enter new token :", token);
    if (newToken !== null && newToken.length <= 32) {
        token = newToken;
        localStorage.setItem("token", token);
        checkLink();
        displayValue();
        checkArraySize();
        fetchDataAndExtractVariables();    }}

function fetchDataAndExtractVariables() {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    var responseText = this.responseText;

                    var startIndex = responseText.indexOf("Sw1=");
                    var endIndex = responseText.indexOf("&Sw2=");
                    var Sw1 = responseText.substring(startIndex + 4, endIndex);

                    startIndex = responseText.indexOf("&Sw2=");
                    endIndex = responseText.indexOf("&Sw3=");
                    var Sw2 = responseText.substring(startIndex + 5, endIndex);

                    startIndex = responseText.indexOf("&Sw3=");
                    endIndex = responseText.indexOf("&Sw4=");
                    var Sw3 = responseText.substring(startIndex + 5, endIndex);
                    
                    document.getElementById("led1").innerText = Sw1;
                    document.getElementById("led2").innerText = Sw2;
                    document.getElementById("led3").innerText = Sw3;

                }}; 
            xhttp.open("GET", "https://"+server+".blynk.cloud/external/api/get?token=" + token + "&v4", true);
            xhttp.send();        }
        
        
        document.addEventListener('DOMContentLoaded', function() {
    var changeStyleButton = document.getElementById('changeStyleButton');
    var ledContainer = document.querySelector('.led-container');
    var isGridThreeColumns = true; 
    
    
function toggleGridStyle() {
        if (isGridThreeColumns) {
            ledContainer.style.gridTemplateColumns = 'repeat(1, 1fr)';
            isGridThreeColumns = false;  } 
        else {
            ledContainer.style.gridTemplateColumns = 'repeat(3, 1fr)';
            isGridThreeColumns = true;    }
        localStorage.setItem('gridStyle', isGridThreeColumns ? 'grid3' : 'grid1');    }
    var lastGridStyle = localStorage.getItem('gridStyle');
    if (lastGridStyle === 'grid1') {
        ledContainer.style.gridTemplateColumns = 'repeat(1, 1fr)';
        isGridThreeColumns = false;    } 
        else {
        ledContainer.style.gridTemplateColumns = 'repeat(3, 1fr)';
        isGridThreeColumns = true;    }
        changeStyleButton.addEventListener('click', toggleGridStyle);
    });
    

(function() {
     	checkLink();
	    fetchDataAndExtractVariables();
	    displayValue();
    	checkArraySize();
})();

setInterval(checkLink, 30000);
setInterval(displayValue, 150);
</script>


</head>
<body>
    <h1>ESP Web Server</h1>
    <p id="result"></p>

    <div class="led-container">
        <!-- Buttons from 1 to 8 initially hidden -->
        <button id="led1" class="led-button" onclick="updateValue(1, this.id)">Button 1</button>
        <button id="led2" class="led-button" onclick="updateValue(2, this.id)">Button 2</button>
        <button id="led3" class="led-button" onclick="updateValue(3, this.id)">Button 3</button>

    </div>
    <br><br><br><br>
    
    <button onclick="setToken()">Set Token</button>
    <br><br>
    <button id="changeStyleButton">Change Style</button>
    <p id="value"></p>

</body>
</html>
